#!/bin/sh
set -e

docker_compose() {
  cd ~/src/cc/harness
  exec docker-compose \
    --file docker-compose.yml \
    --file docker-compose.local.yml \
    "$@"
}

docker_compose_noexec() {
  cd ~/src/cc/harness
  docker-compose \
    --file docker-compose.yml \
    --file docker-compose.local.yml \
    "$@"
}

update_repo() {
  printf "=== Updating %s\n" "$1"
  set +e
  cd "$1" && git checkout -q master && git pull -q
  if [ $? -ne 0 ]; then
    printf "=== WARN: %s failed to update successfully\n" "$1"
  fi
  set -e
}

update_repos() {
  cd ~/src/cc
  echo "== git pull all repos"
  for repo in *; do
    update_repo "$repo"
  done
  echo "== docker-compose build"
  docker_compose build
}

case "$1" in
  restart)
    docker_compose_noexec stop "$2"
    docker_compose_noexec rm -f "$2"
    docker_compose_noexec up -d "$2"
  ;;
  describe-topics)
    # WTF do you sleep .1, you may ask? https://github.com/docker/compose/issues/3267
    # ignore shellcheck about quoting: we want those vars expanded in-container
    # shellcheck disable=SC2016
    docker_compose run --rm -T \
      kafka sh -c \
      'sleep .1; $KAFKA_HOME/bin/kafka-topics.sh --describe --zookeeper $KAFKA_ZOOKEEPER_CONNECT'
  ;;
  up-retry)
    docker_compose_noexec up -d
    sleep 3
    docker_compose_noexec up -d
    sleep 3
    docker_compose_noexec up -d
  ;;
  down)
    echo "FYI: down deletes volumes, this probably wasn't what you wanted! Stopping instead."
    docker_compose stop
  ;;
  git-update)
    update_repos;
  ;;
  *) docker_compose "$@";;
esac
